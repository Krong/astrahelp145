name: Build RustDesk Client

on:
  workflow_dispatch: # Позволяет запускать сборку вручную кнопкой
  push:
    branches:
      - master
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'

jobs:
  # =========================================================
  # СБОРКА ДЛЯ WINDOWS
  # =========================================================
  build-windows:
    name: Build for Windows
    runs-on: windows-2022
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install LLVM and generic tools
        run: |
          choco install llvm -y
          git config --global core.longpaths true

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Install vcpkg (C++ dependencies)
        # RustDesk использует vcpkg для статических библиотек на Windows
        run: |
          git clone https://github.com/microsoft/vcpkg.git
          .\vcpkg\bootstrap-vcpkg.bat
          .\vcpkg\vcpkg install libvpx:x64-windows-static libyuv:x64-windows-static opus:x64-windows-static aom:x64-windows-static
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg

      - name: Install flutter_rust_bridge_codegen
        # Важно: версия должна соответствовать той, что в Cargo.toml, но обычно latest работает, если проект обновлен
        run: cargo install flutter_rust_bridge_codegen

      - name: Build Windows Client
        shell: cmd
        env:
          # Указываем путь к vcpkg для скрипта сборки
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
        run: |
          python build.py --windows --flutter

      - name: Upload Artifact (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-windows-client
          path: flutter/build/windows/x64/runner/Release/*.exe

  # =========================================================
  # СБОРКА ДЛЯ LINUX
  # =========================================================
  build-linux:
    name: Build for Linux
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget gcc g++ git clang cmake \
            libssl-dev libgtk-3-dev libayatana-appindicator3-dev \
            libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
            llvm-dev libclang-dev libfuse2 \
            libasound2-dev libpulse-dev libx11-dev libxext-dev \
            libxrandr-dev libxcursor-dev libxfixes-dev libxi-dev

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Install flutter_rust_bridge_codegen
        run: cargo install flutter_rust_bridge_codegen

      - name: Build Linux Client
        run: |
          # Выполняем сборку через официальный скрипт
          python3 build.py --linux --flutter

      - name: Upload Artifact (Linux AppImage/Deb)
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-linux-client
          # Обычно build.py складывает готовые пакеты в корень или специальную папку build
          # Здесь мы пытаемся захватить собранный bundle
          path: flutter/build/linux/x64/release/bundle/rustdesk